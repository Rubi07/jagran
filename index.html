<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>‡¶ú‡¶® ‡¶ú‡¶æ‡¶ó‡¶∞‡¶£</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #1a237e; --bg: #f4f7f6; }
    body { background: var(--bg); font-family: 'Hind Siliguri', sans-serif; color: #333; }
    .nav-top { background: var(--primary); color: white; padding: 15px; text-align: center; font-weight: 700; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
    .card-custom { border-radius: 15px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 15px; background: white; }
    .btn-main { background: var(--primary); color: white; border-radius: 10px; font-weight: 600; padding: 12px; border: none; width: 100%; transition: 0.3s; }
    .btn-main:active { transform: scale(0.98); }
    .role-badge { font-size: 0.75rem; padding: 4px 8px; border-radius: 5px; background: #e8eaf6; color: var(--primary); font-weight: bold; }
    .loading-screen { display: flex; justify-content: center; align-items: center; height: 80vh; flex-direction: column; }
  </style>
</head>
<body>

<div class="nav-top">‡¶ú‡¶® ‡¶ú‡¶æ‡¶ó‡¶∞‡¶£ ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶∏‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶∞</div>

<div id="app" class="container mt-3 pb-5">
    <div class="loading-screen">
        <div class="spinner-border text-primary"></div>
        <p class="mt-2">‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
    </div>
</div>

<script>
// ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶ö‡ßÇ‡ßú‡¶æ‡¶®‡ßç‡¶§ API ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï
const API = "https://script.google.com/macros/s/AKfycbwkQNXB1bQqVKtIR9ph_sIe1z-fQPbtgDrEJwMmVPo2vR-exy3N1VvPF1DKRWpa8ekW8Q/exec";

let state = { user: null, members: [], config: null };

window.onload = () => {
  // ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶ï‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
  if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js').catch(e => console.error(e)); }
  
  const saved = localStorage.getItem('jj_session');
  if(saved) { 
    state = JSON.parse(saved); 
    renderDashboard(); 
  } else { 
    renderLogin(); 
  }
};

async function call(action, data = {}) {
  try {
    const res = await fetch(API, { method: 'POST', body: JSON.stringify({action, ...data}) });
    return await res.json();
  } catch (e) { 
    console.error(e);
    alert("‡¶®‡ßá‡¶ü‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø! ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶∏‡¶ö‡¶≤ ‡¶Ü‡¶õ‡ßá ‡¶è‡¶¨‡¶Ç ‡¶ó‡ßÅ‡¶ó‡¶≤ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü 'Anyone' ‡¶Æ‡ßÅ‡¶°‡ßá ‡¶™‡¶æ‡¶¨‡¶≤‡¶ø‡¶∂ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§"); 
    return {status: 'error'}; 
  }
}

function renderLogin() {
  document.getElementById('app').innerHTML = `
    <div class="card card-custom p-4 mt-5">
      <h4 class="text-center mb-4 fw-bold" style="color: var(--primary)">‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ</h4>
      <input id="ph" class="form-control mb-3" type="tel" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞" autocomplete="username">
      <input id="ps" class="form-control mb-4" type="password" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°" autocomplete="current-password">
      <button class="btn btn-main" onclick="doLogin()">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>`;
}

async function doLogin() {
  const ph = document.getElementById('ph').value;
  const ps = document.getElementById('ps').value;
  if(!ph || !ps) return alert("‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®");
  
  const res = await call('login', { phone: ph, pass: ps });
  if(res.status === 'success') {
    state = res;
    localStorage.setItem('jj_session', JSON.stringify(res));
    renderDashboard();
  } else {
    alert(res.msg);
  }
}

function renderDashboard() {
  const u = state.user;
  const news = (u.role === 'Admin' || u.role === 'Leader') ? state.config.nLead : state.config.nAll;

  let html = `
    <div class="card card-custom p-3 bg-white mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <strong>‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶ò‡ßã‡¶∑‡¶£‡¶æ</strong>
        <button class="btn btn-sm btn-outline-primary" onclick="changePass()">‡¶™‡¶ø‡¶® ‡¶¨‡¶¶‡¶≤‡¶æ‡¶®</button>
      </div>
      <p class="mb-0 text-primary fw-semibold">${news || '‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßã‡¶®‡ßã ‡¶ò‡ßã‡¶∑‡¶£‡¶æ ‡¶®‡ßá‡¶á'}</p>
    </div>
    
    <div class="d-flex justify-content-between align-items-center px-1 mb-3">
        <h6 class="mb-0 fw-bold">‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ (${state.members.length})</h6>
    </div>
  `;

  html += state.members.map(m => `
    <div class="card card-custom p-3 mb-2">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="fw-bold">${m.name}</div>
          <div class="text-muted small">${m.dist} | <span class="role-badge">${m.desig}</span></div>
        </div>
        <div class="d-flex gap-2">
          <a href="tel:${m.phone}" class="btn btn-success btn-sm rounded-circle">üìû</a>
          ${(u.role === 'Admin' || u.role === 'Leader') ? `<button class="btn btn-light btn-sm border" onclick="editRole('${m.phone}')">‚öôÔ∏è</button>` : ''}
        </div>
      </div>
    </div>
  `).join('');

  document.getElementById('app').innerHTML = html + `<button class="btn btn-outline-danger w-100 mt-4 mb-5" onclick="logout()">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>`;
}

async function changePass() {
    const newP = prompt("‡¶®‡¶§‡ßÅ‡¶® ‡ß™ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶™‡¶ø‡¶® ‡¶¶‡¶ø‡¶®:");
    if(newP && newP.length >= 4) {
        const res = await call('changePass', { phone: state.user.phone, newPass: newP });
        alert(res.msg);
    }
}

async function editRole(target) {
    const newD = prompt("‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶¶‡¶¨‡ßÄ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶â‡¶¶‡¶æ: ‡¶Æ‡¶®‡ßç‡¶°‡¶≤ ‡¶™‡ßç‡¶∞‡¶Æ‡ßÅ‡¶ñ):");
    if(newD) {
        const res = await call('updateRole', { targetPhone: target, newDesig: newD });
        alert(res.msg);
        location.reload();
    }
}

function logout() { 
  localStorage.clear(); 
  location.reload(); 
}
</script>
</body>
</html>
